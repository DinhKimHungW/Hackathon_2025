name: Deploy to Azure

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'

env:
  AZURE_RESOURCE_GROUP: rg-portlink-${{ github.event.inputs.environment || 'dev' }}
  AZURE_LOCATION: eastasia
  BACKEND_APP_NAME: ca-portlink-backend-${{ github.event.inputs.environment || 'dev' }}
  FRONTEND_APP_NAME: ca-portlink-frontend-${{ github.event.inputs.environment || 'dev' }}

jobs:
  # ============================================================================
  # Build and Test
  # ============================================================================
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json
      
      - name: ðŸ“¦ Install backend dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: ðŸ”¨ Build backend
        working-directory: ./backend
        run: npm run build
      
      - name: ðŸ§ª Test backend
        working-directory: ./backend
        run: npm test
      
      - name: ðŸ“¦ Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: ðŸ”¨ Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          VITE_API_BASE_URL: https://placeholder.azurecontainerapps.io/api/v1
          VITE_WS_URL: wss://placeholder.azurecontainerapps.io

  # ============================================================================
  # Deploy Infrastructure
  # ============================================================================
  deploy-infra:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    outputs:
      acr-login-server: ${{ steps.deploy.outputs.acrLoginServer }}
      backend-url: ${{ steps.deploy.outputs.backendUrl }}
      frontend-url: ${{ steps.deploy.outputs.frontendUrl }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: ðŸ—ï¸ Create Resource Group
        run: |
          az group create \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --location ${{ env.AZURE_LOCATION }} \
            --tags environment=${{ github.event.inputs.environment || 'dev' }} project=PortLink
      
      - name: âœ… Validate Bicep
        run: |
          az deployment group validate \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --template-file ./infra/main.bicep \
            --parameters environmentName=${{ github.event.inputs.environment || 'dev' }} \
            --parameters location=${{ env.AZURE_LOCATION }} \
            --parameters postgresAdminUser=${{ secrets.POSTGRES_ADMIN_USER }} \
            --parameters postgresAdminPassword=${{ secrets.POSTGRES_ADMIN_PASSWORD }} \
            --parameters redisPassword=${{ secrets.REDIS_PASSWORD }} \
            --parameters jwtSecret=${{ secrets.JWT_SECRET }} \
            --parameters jwtRefreshSecret=${{ secrets.JWT_REFRESH_SECRET }}
      
      - name: ðŸ” What-If Analysis
        run: |
          az deployment group what-if \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --template-file ./infra/main.bicep \
            --parameters environmentName=${{ github.event.inputs.environment || 'dev' }} \
            --parameters location=${{ env.AZURE_LOCATION }} \
            --parameters postgresAdminUser=${{ secrets.POSTGRES_ADMIN_USER }} \
            --parameters postgresAdminPassword=${{ secrets.POSTGRES_ADMIN_PASSWORD }} \
            --parameters redisPassword=${{ secrets.REDIS_PASSWORD }} \
            --parameters jwtSecret=${{ secrets.JWT_SECRET }} \
            --parameters jwtRefreshSecret=${{ secrets.JWT_REFRESH_SECRET }}
      
      - name: ðŸš€ Deploy Infrastructure
        id: deploy
        run: |
          DEPLOYMENT_OUTPUT=$(az deployment group create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --template-file ./infra/main.bicep \
            --parameters environmentName=${{ github.event.inputs.environment || 'dev' }} \
            --parameters location=${{ env.AZURE_LOCATION }} \
            --parameters postgresAdminUser=${{ secrets.POSTGRES_ADMIN_USER }} \
            --parameters postgresAdminPassword=${{ secrets.POSTGRES_ADMIN_PASSWORD }} \
            --parameters redisPassword=${{ secrets.REDIS_PASSWORD }} \
            --parameters jwtSecret=${{ secrets.JWT_SECRET }} \
            --parameters jwtRefreshSecret=${{ secrets.JWT_REFRESH_SECRET }} \
            --name "portlink-$(date +%Y%m%d%H%M%S)" \
            --output json)
          
          echo "acrLoginServer=$(echo $DEPLOYMENT_OUTPUT | jq -r '.properties.outputs.acrLoginServer.value')" >> $GITHUB_OUTPUT
          echo "backendUrl=$(echo $DEPLOYMENT_OUTPUT | jq -r '.properties.outputs.backendUrl.value')" >> $GITHUB_OUTPUT
          echo "frontendUrl=$(echo $DEPLOYMENT_OUTPUT | jq -r '.properties.outputs.frontendUrl.value')" >> $GITHUB_OUTPUT

  # ============================================================================
  # Build and Push Docker Images
  # ============================================================================
  build-push-images:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: deploy-infra
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ðŸ”‘ Login to Azure Container Registry
        run: |
          az acr login --name $(echo ${{ needs.deploy-infra.outputs.acr-login-server }} | cut -d'.' -f1)
      
      - name: ðŸ”¨ Build and Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ needs.deploy-infra.outputs.acr-login-server }}/portlink-backend:${{ github.sha }},${{ needs.deploy-infra.outputs.acr-login-server }}/portlink-backend:latest
          cache-from: type=registry,ref=${{ needs.deploy-infra.outputs.acr-login-server }}/portlink-backend:buildcache
          cache-to: type=registry,ref=${{ needs.deploy-infra.outputs.acr-login-server }}/portlink-backend:buildcache,mode=max
      
      - name: ðŸ”¨ Build and Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ needs.deploy-infra.outputs.acr-login-server }}/portlink-frontend:${{ github.sha }},${{ needs.deploy-infra.outputs.acr-login-server }}/portlink-frontend:latest
          build-args: |
            VITE_API_BASE_URL=${{ needs.deploy-infra.outputs.backend-url }}/api/v1
            VITE_WS_URL=${{ needs.deploy-infra.outputs.backend-url }}
          cache-from: type=registry,ref=${{ needs.deploy-infra.outputs.acr-login-server }}/portlink-frontend:buildcache
          cache-to: type=registry,ref=${{ needs.deploy-infra.outputs.acr-login-server }}/portlink-frontend:buildcache,mode=max

  # ============================================================================
  # Deploy Container Apps
  # ============================================================================
  deploy-apps:
    name: Deploy Container Apps
    runs-on: ubuntu-latest
    needs: [deploy-infra, build-push-images]
    
    steps:
      - name: ðŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: ðŸš€ Deploy Backend Container App
        run: |
          az containerapp update \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ needs.deploy-infra.outputs.acr-login-server }}/portlink-backend:${{ github.sha }}
      
      - name: ðŸš€ Deploy Frontend Container App
        run: |
          az containerapp update \
            --name ${{ env.FRONTEND_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ needs.deploy-infra.outputs.acr-login-server }}/portlink-frontend:${{ github.sha }}
      
      - name: â³ Wait for deployment to stabilize
        run: sleep 30
      
      - name: ðŸ” Verify Backend Health
        run: |
          BACKEND_URL="${{ needs.deploy-infra.outputs.backend-url }}"
          echo "Checking health at: $BACKEND_URL/api/v1/health"
          
          MAX_RETRIES=10
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/api/v1/health" || echo "000")
            
            if [ "$STATUS_CODE" = "200" ]; then
              echo "âœ… Backend is healthy (Status: $STATUS_CODE)"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Attempt $RETRY_COUNT/$MAX_RETRIES - Status: $STATUS_CODE - Retrying in 10 seconds..."
            sleep 10
          done
          
          echo "âŒ Backend health check failed after $MAX_RETRIES attempts"
          exit 1
      
      - name: ðŸ” Verify Frontend Health
        run: |
          FRONTEND_URL="${{ needs.deploy-infra.outputs.frontend-url }}"
          echo "Checking frontend at: $FRONTEND_URL"
          
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL" || echo "000")
          
          if [ "$STATUS_CODE" = "200" ]; then
            echo "âœ… Frontend is accessible (Status: $STATUS_CODE)"
          else
            echo "âš ï¸ Frontend returned status: $STATUS_CODE"
            exit 1
          fi

  # ============================================================================
  # Post-Deployment Tasks
  # ============================================================================
  post-deploy:
    name: Post-Deployment Tasks
    runs-on: ubuntu-latest
    needs: [deploy-infra, deploy-apps]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: ðŸ“Š Create Deployment Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸŽ‰ Deployment Successful
          
          ### ðŸ“‹ Application URLs
          - **Frontend**: [${{ needs.deploy-infra.outputs.frontend-url }}](${{ needs.deploy-infra.outputs.frontend-url }})
          - **Backend**: [${{ needs.deploy-infra.outputs.backend-url }}](${{ needs.deploy-infra.outputs.backend-url }})
          
          ### ðŸ”— Azure Resources
          - **Resource Group**: ${{ env.AZURE_RESOURCE_GROUP }}
          - **Environment**: ${{ github.event.inputs.environment || 'dev' }}
          - **Region**: ${{ env.AZURE_LOCATION }}
          
          ### ðŸ“¦ Deployed Images
          - Backend: \`${{ needs.deploy-infra.outputs.acr-login-server }}/portlink-backend:${{ github.sha }}\`
          - Frontend: \`${{ needs.deploy-infra.outputs.acr-login-server }}/portlink-frontend:${{ github.sha }}\`
          
          ### â±ï¸ Deployment Info
          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}
          - **Triggered by**: ${{ github.actor }}
          - **Time**: $(date -u)
          EOF
      
      - name: ðŸ“ View Logs
        if: failure()
        run: |
          echo "Fetching backend logs..."
          az containerapp logs show \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --tail 50
